openapi: 3.1.0
info:
  title: Shovel Heroes Public API
  version: 0.1.0
  description: |
    REST endpoints replacing previous Base44 SDK usage.
    This spec is inferred from the frontend code. Adjust field types and required properties to match your backend.
    
    API for disaster relief coordination: tasks, volunteer sign-ups, check-ins, and resource points.
    Includes server-side rate limiting, idempotent POSTs, and security headers guidance.
  contact:
    name: Maintainers
    email: shovel-heroes@noreply.github.com
servers:
  - url: https://your.api.server
    description: Production
  - url: http://localhost:8787
    description: Local Dev

tags:
  - name: DisasterAreas
    description: 災區相關查詢與維護
  - name: Grids
    description: 救援/資源網格 CRUD 與狀態
  - name: VolunteerRegistrations
    description: 志工報名與取消
  - name: SupplyDonations
    description: 物資捐贈紀錄
  - name: GridDiscussions
    description: 網格討論留言
  - name: Announcements
    description: 系統公告 / 廣播訊息
  - name: Volunteers
    description: 志工名單或聚合資訊
  - name: Users
    description: 使用者與登入資訊
  - name: Functions
    description: 匯入匯出 / 後端批次或延伸功能
  - name: Legacy
    description: 與舊系統資料同步的 v2 相容端點
  - name: Health
    description: System health and status monitoring
  - name: Tasks
    description: Disaster relief task management
  - name: Checkins
    description: Field check-in tracking for volunteers
  - name: ResourcePoints
    description: Resource point locations (shelters, supplies, medical)

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      description: Check API service health and uptime
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                required: [status, uptimeSec]
                properties:
                  status: { type: string, enum: [ok] }
                  uptimeSec: { type: number, minimum: 0 }
              example:
                status: ok
                uptimeSec: 3600
  /tasks:
    get:
      tags: [Tasks]
      summary: List tasks
      description: Retrieve list of disaster relief tasks with optional filtering
      parameters:
        - in: query
          name: status
          description: Filter tasks by status
          schema: { type: string, enum: [open, assigned, done, cancelled] }
        - in: query
          name: bbox
          description: Filter by bounding box [minLon,minLat,maxLon,maxLat]
          style: form
          explode: false
          schema:
            type: array
            minItems: 4
            maxItems: 4
            items: { type: number }
          example: [121.5, 24.0, 121.6, 24.1]
      responses:
        '200':
          description: Task list
          headers:
            RateLimit:
              description: Number of requests remaining in current window
              schema: { type: string }
              example: "100"
            RateLimit-Policy:
              description: Rate limit policy in effect
              schema: { type: string }
              example: "100;w=30"
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Task' }
                  nextCursor: { type: string, nullable: true }
  /tasks/{id}:
    get:
      tags: [Tasks]
      summary: Get one task
      description: Retrieve detailed information for a specific task
      parameters:
        - in: path
          name: id
          required: true
          description: Task UUID
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: Task details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Task' }
        '404': { $ref: '#/components/responses/NotFound' }

  /volunteers/signups:
    post:
      tags: [Volunteers]
      summary: Create a volunteer signup (idempotent)
      description: >
        Register a new volunteer. Accepts an optional `Idempotency-Key` header
        to deduplicate identical submissions within a 10-minute window.
      parameters:
        - in: header
          name: Idempotency-Key
          required: false
          description: UUID v4 for idempotent submission (prevents duplicate signups within 10 minutes)
          schema:
            type: string
            format: uuid
            maxLength: 36
            minLength: 36
          example: "123e4567-e89b-12d3-a456-426614174000"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/VolunteerSignup' }
      responses:
        '201':
          description: Volunteer signup created successfully
          headers:
            RateLimit:
              description: Requests remaining in current window
              schema: { type: string }
            RateLimit-Policy:
              description: Rate limit policy
              schema: { type: string }
          content:
            application/json:
              schema: { $ref: '#/components/schemas/VolunteerSignupReceipt' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '409':
          description: Duplicate submission detected within idempotency window
          headers:
            Retry-After:
              description: Seconds until the idempotency window resets
              schema: { type: integer }
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '429': { $ref: '#/components/responses/TooManyRequests' }

  /checkins:
    post:
      tags: [Checkins]
      summary: Field check-in
      description: Record volunteer location check-in (requires authentication)
      security:
        - bearerAuth: []
      parameters:
        - in: header
          name: Idempotency-Key
          required: false
          description: UUID v4 for idempotent submission
          schema:
            type: string
            format: uuid
            maxLength: 36
            minLength: 36
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Checkin' }
      responses:
        '201':
          description: Check-in recorded successfully
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CheckinReceipt' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '429': { $ref: '#/components/responses/TooManyRequests' }

  /resource-points:
    get:
      tags: [ResourcePoints]
      summary: List resource points
      description: Retrieve locations of shelters, supply depots, and medical facilities
      responses:
        '200':
          description: Resource point list
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/ResourcePoint' }

  /announcements:
    get:
      tags: [Announcements]
      summary: List announcements
      description: Retrieve system announcements and safety information
      parameters:
        - in: query
          name: category
          description: Filter by announcement category
          schema: { type: string, enum: [safety, equipment, general] }
        - in: query
          name: pinned_only
          description: Show only pinned announcements
          schema: { type: boolean }
      responses:
        '200':
          description: Announcement list
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Announcement' }

  /disaster-areas:
    get:
      tags: [DisasterAreas]
      summary: List disaster areas
      description: Retrieve all disaster areas and their boundaries
      parameters:
        - in: query
          name: status
          description: Filter by disaster area status
          schema: { type: string, enum: [active, closed, preparing] }
      responses:
        '200':
          description: Disaster area list
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/DisasterArea' }

  /disaster-areas/{id}:
    get:
      tags: [DisasterAreas]
      summary: Get disaster area details
      description: Retrieve detailed information for a specific disaster area
      parameters:
        - in: path
          name: id
          required: true
          description: Disaster area ID
          schema: { type: string }
      responses:
        '200':
          description: Disaster area details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/DisasterArea' }
        '404': { $ref: '#/components/responses/NotFound' }

  /grids:
    get:
      tags: [Grids]
      summary: List grids
      description: Retrieve work grids within disaster areas
      parameters:
        - in: query
          name: disaster_area_id
          description: Filter by disaster area
          schema: { type: string }
        - in: query
          name: grid_type
          description: Filter by grid type
          schema: { type: string, enum: [mud_disposal, manpower, supply_storage, accommodation, food_area] }
        - in: query
          name: status
          description: Filter by grid status
          schema: { type: string, enum: [planning, open, in_progress, completed, closed] }
      responses:
        '200':
          description: Grid list
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Grid' }

  /grids/{id}:
    get:
      tags: [Grids]
      summary: Get grid details
      description: Retrieve detailed information for a specific grid
      parameters:
        - in: path
          name: id
          required: true
          description: Grid ID
          schema: { type: string }
      responses:
        '200':
          description: Grid details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Grid' }
        '404': { $ref: '#/components/responses/NotFound' }

  /grids/{id}/volunteer-registrations:
    post:
      tags: [Grids]
      summary: Register volunteer for grid
      description: Register a volunteer for a specific grid work area
      parameters:
        - in: path
          name: id
          required: true
          description: Grid ID
          schema: { type: string }
        - in: header
          name: Idempotency-Key
          required: false
          description: UUID v4 for idempotent submission
          schema:
            type: string
            format: uuid
            maxLength: 36
            minLength: 36
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/GridVolunteerRegistration' }
      responses:
        '201':
          description: Volunteer registration successful
          content:
            application/json:
              schema: { $ref: '#/components/schemas/GridVolunteerRegistrationReceipt' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '404': { $ref: '#/components/responses/NotFound' }
        '409':
          description: Duplicate registration detected
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /grids/{id}/discussions:
    get:
      tags: [GridDiscussions]
      summary: Get grid discussions
      description: Retrieve discussions and messages for a specific grid
      parameters:
        - in: path
          name: id
          required: true
          description: Grid ID
          schema: { type: string }
        - in: query
          name: message_type
          description: Filter by message type
          schema: { type: string, enum: [info, question, update, alert] }
        - in: query
          name: pinned_only
          description: Show only pinned messages
          schema: { type: boolean }
      responses:
        '200':
          description: Grid discussion messages
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/GridDiscussion' }
    post:
      tags: [GridDiscussions]
      summary: Post message to grid
      description: Post a new message or update to grid discussion
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Grid ID
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/GridDiscussionPost' }
      responses:
        '201':
          description: Message posted successfully
          content:
            application/json:
              schema: { $ref: '#/components/schemas/GridDiscussion' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }

  /supply-donations:
    post:
      tags: [SupplyDonations]
      summary: Create supply donation
      description: Register a new supply donation for a specific grid
      parameters:
        - in: header
          name: Idempotency-Key
          required: false
          description: UUID v4 for idempotent submission
          schema:
            type: string
            format: uuid
            maxLength: 36
            minLength: 36
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SupplyDonation' }
      responses:
        '201':
          description: Supply donation registered successfully
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SupplyDonationReceipt' }
        '400': { $ref: '#/components/responses/BadRequest' }

  /supply-donations/{id}:
    get:
      tags: [SupplyDonations]
      summary: Get donation details
      description: Retrieve details of a specific supply donation
      parameters:
        - in: path
          name: id
          required: true
          description: Donation ID
          schema: { type: string }
      responses:
        '200':
          description: Supply donation details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SupplyDonation' }
        '404': { $ref: '#/components/responses/NotFound' }
    patch:
      tags: [SupplyDonations]
      summary: Update donation status
      description: Update the status of a supply donation
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: Donation ID
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [pledged, confirmed, in_transit, delivered, cancelled]
                received_photo:
                  type: string
                  description: Photo URL for delivery confirmation
                notes:
                  type: string
                  maxLength: 500
      responses:
        '200':
          description: Donation status updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SupplyDonation' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }

  /volunteer-registrations:
    get:
      summary: List volunteer registrations
      description: 取得所有志工報名紀錄 (未加分頁僅示範)。
      tags: [VolunteerRegistrations]
      parameters:
        - $ref: '#/components/parameters/PageLimit'
        - $ref: '#/components/parameters/PageOffset'
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/VolunteerRegistration' } } } } }
        '500': { $ref: '#/components/responses/InternalError' }
    post:
      summary: Register volunteer
      description: 志工報名參與指定網格。
      tags: [VolunteerRegistrations]
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/VolunteerRegistration' }
      responses:
        '201': { description: Created }
        '400': { $ref: '#/components/responses/ValidationError' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '500': { $ref: '#/components/responses/InternalError' }
  /volunteer-registrations/{id}:
    delete:
      summary: Cancel volunteer registration
      description: 取消指定志工報名。
      tags: [VolunteerRegistrations]
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: id
          required: true
          schema: { $ref: '#/components/schemas/ID' }
      responses:
        '204': { description: Deleted }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }
        '500': { $ref: '#/components/responses/InternalError' }

  /volunteers:
    get:
      summary: List volunteers
      description: |
        取得志工報名清單（整合報名與使用者呈現所需欄位）。
        回傳封裝含 `data` 與 `can_view_phone` 供前端判斷是否顯示電話。
        欄位 `created_date` 目前沿用前端既有命名；若要統一建議改為 `created_at` 並同步前端。
      tags: [Volunteers]
      parameters:
        - name: grid_id
          in: query
          required: false
          schema: { $ref: '#/components/schemas/ID' }
          description: 過濾指定網格的志工
        - name: status
          in: query
          required: false
          schema: { $ref: '#/components/schemas/VolunteerStatus' }
          description: 過濾指定狀態
        - name: include_counts
          in: query
          required: false
          schema: { type: boolean, default: true }
          description: 是否回傳狀態統計 `status_counts`
        - $ref: '#/components/parameters/PageLimit'
        - $ref: '#/components/parameters/PageOffset'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VolunteersListResponse'
        '500': { $ref: '#/components/responses/InternalError' }

  /users:
    get:
      summary: List users
      description: 取得使用者列表 (需權限)。
      tags: [Users]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/User' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '500': { $ref: '#/components/responses/InternalError' }
  /me:
    get:
      summary: Get current user
      description: 回傳目前登入的使用者資訊。
      tags: [Users]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '500': { $ref: '#/components/responses/InternalError' }

  /functions/fix-grid-bounds:
    post:
      summary: Normalize / repair stored grid bounds
      description: 批次修正網格邊界 (僅管理維運)。
      tags: [Functions]
      security: [ { bearerAuth: [] } ]
      responses:
        '200': { description: Done }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '500': { $ref: '#/components/responses/InternalError' }
  /functions/export-grids-csv:
    get:
      summary: Export grids as CSV
      description: 匯出所有網格資料為 CSV 檔。
      tags: [Functions]
      responses:
        '200':
          description: CSV content
          content:
            text/csv:
              schema: { type: string, description: CSV text }
        '500': { $ref: '#/components/responses/InternalError' }
  /functions/import-grids-csv:
    post:
      summary: Import grids from CSV content
      description: 從 CSV 內容匯入 / 更新網格。
      tags: [Functions]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                csv: { type: string }
              required: [csv]
      responses:
        '200': { description: Import result }
        '400': { $ref: '#/components/responses/ValidationError' }
        '500': { $ref: '#/components/responses/InternalError' }
  /functions/grid-template:
    get:
      summary: Download blank grid template CSV
      description: 下載空白網格匯入範本。
      tags: [Functions]
      responses:
        '200': { description: CSV }
        '500': { $ref: '#/components/responses/InternalError' }
  /functions/external-grid-api:
    post:
      summary: Proxy / external grid API call
      description: 代理對外部網格系統的呼叫。
      tags: [Functions]
      requestBody:
        required: true
        content:
          application/json:
            schema: { type: object }
      responses:
        '200': { description: OK }
        '400': { $ref: '#/components/responses/ValidationError' }
        '500': { $ref: '#/components/responses/InternalError' }
  /functions/external-volunteer-api:
    post:
      summary: Proxy / external volunteer API call
      description: 代理對外部志工系統的呼叫。
      tags: [Functions]
      requestBody:
        required: true
        content:
          application/json:
            schema: { type: object }
      responses:
        '200': { description: OK }
        '400': { $ref: '#/components/responses/ValidationError' }
        '500': { $ref: '#/components/responses/InternalError' }

  /api/v2/sync:
    post:
      summary: Sync legacy data (v2)
      description: 與舊版系統同步資料 (可能為非同步背景作業)。
      tags: [Legacy]
      responses:
        '200': { description: Sync started }
        '500': { $ref: '#/components/responses/InternalError' }
  /api/v2/roster:
    get:
      summary: Get roster (v2)
      description: 取得舊系統格式之 roster 資料。
      tags: [Legacy]
      responses:
        '200': { description: OK }
        '500': { $ref: '#/components/responses/InternalError' }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    PageLimit:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 50
      description: 單頁筆數 (預設 50, 上限 200)
    PageOffset:
      name: offset
      in: query
      required: false
      schema:
        type: integer
        minimum: 0
        default: 0
      description: 起始位移 (用於分頁)

  responses:
    Unauthorized:
      description: 未授權 (需要 Bearer Token)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: 找不到資源
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    ValidationError:
      description: 請求參數或內容驗證失敗
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    InternalError:
      description: 伺服器內部錯誤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    BadRequest:
      description: Invalid request parameters or body
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
    TooManyRequests:
      description: Rate limit exceeded or duplicate submission within cooldown
      headers:
        Retry-After:
          description: Seconds until requests can resume
          schema: { type: integer }
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }

  schemas:
    ID:
      type: string
      description: 唯一識別字串 (UUID、ULID 或資料庫主鍵)
      example: "grid_01HZYQ9W123ABCDEF"
    Timestamp:
      type: string
      format: date-time
      description: ISO 8601 時間戳記 (UTC)
      example: "2025-10-02T08:12:30Z"
    SupplyNeed:
      type: object
      properties:
        name:
          type: string
          description: 需求物資名稱
          example: 鋤頭
        quantity:
          type: integer
          description: 需求總數量
          example: 20
        unit:
          type: string
          description: 數量單位
          example: 支
        received:
          type: integer
          description: 已收到的數量
          default: 0
          example: 5
      required: [name, quantity, unit]
    VolunteerRegistration:
      type: object
      description: 志工報名原始紀錄 (對應 Base44 VolunteerRegistration)
      properties:
        id:
          $ref: '#/components/schemas/ID'
        grid_id:
          $ref: '#/components/schemas/ID'
        volunteer_name:
          type: string
          description: 報名者名稱
          example: 王銓詰
        volunteer_phone:
          type: string
          nullable: true
          description: 電話 (可能缺省或僅內部可見)
          example: "0912345678"
        volunteer_email:
          type: string
          nullable: true
          description: 電子郵件
          example: volunteer@example.org
        available_time:
          type: string
          nullable: true
          description: 可服務時間文字
          example: 2025/10/04 上午12:00
        skills:
          type: array
          description: 技能列表
          items:
            type: string
          example:
            - EMT-1
            - 打掃
        equipment:
          type: array
          description: 攜帶工具
          items:
            type: string
          example:
            - 雨鞋
            - 鏟子
        status:
          $ref: '#/components/schemas/VolunteerStatus'
        check_in_time:
          type: string
          format: date-time
          nullable: true
          description: 報到時間 (若已報到)
          example: 2025-10-01T09:00:00Z
        notes:
          type: string
          nullable: true
          description: 備註
          example: 需要手套
        created_by_id:
          $ref: '#/components/schemas/ID'
        created_by:
          type: string
          description: 建立者 (email)
          example: kuo.tanya@gmail.com
        is_sample:
          type: boolean
          description: 是否示範資料
          example: false
        created_date:
          $ref: '#/components/schemas/Timestamp'
        updated_date:
          $ref: '#/components/schemas/Timestamp'
        created_at:
          $ref: '#/components/schemas/Timestamp'
        updated_at:
          $ref: '#/components/schemas/Timestamp'
      required: [id, grid_id, volunteer_name, status]
    ExternalLink:
      type: object
      properties:
        name:
          type: string
          description: 連結名稱
          example: 防災整合地圖
        url:
          type: string
          format: uri
          description: 連結 URL
          example: https://reurl.cc/9nNjqO
      required: [name, url]
    User:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/ID'
        name:
          type: string
          description: 使用者顯示名稱
          example: 林志工
        email:
          type: string
          format: email
          description: 使用者電子郵件
          example: volunteer@example.org
      required: [id]
    VolunteerStatus:
      type: string
      description: 志工報名狀態
      enum: [pending, confirmed, arrived, completed, cancelled]
      example: pending
    VolunteerListItem:
      type: object
      description: 志工報名清單中每一筆資料 (結合報名 + 呈現所需欄位)
      properties:
        id:
          $ref: '#/components/schemas/ID'
        grid_id:
          $ref: '#/components/schemas/ID'
        user_id:
          $ref: '#/components/schemas/ID'
        volunteer_name:
          type: string
          description: 志工顯示名稱 (可能從使用者或表單輸入取得)
          example: 張小強
        volunteer_phone:
          type: string
          nullable: true
          description: 志工電話號碼；若 `can_view_phone=false` 時後端可直接省略或回傳遮蔽版本
          example: 0912-345-678
        status:
          $ref: '#/components/schemas/VolunteerStatus'
        available_time:
          type: string
          nullable: true
          description: 可服務時間文字描述
          example: 10/3 上午或 10/4 全天
        skills:
          type: array
          description: 自述技能 (字串列表)
          items:
            type: string
          example:
            - 挖土機
            - 醫療志工
        equipment:
          type: array
          description: 可攜帶工具 (字串列表)
          items:
            type: string
          example:
            - 鐵鏟
            - 手推車
        notes:
          type: string
          nullable: true
          description: 其他備註
          example: 需要協助調度交通
        created_date:
          type: string
          format: date-time
          description: 報名建立時間 (命名沿用前端使用字段; 與其他資源的 created_at 不同)
          example: 2025-10-02T08:12:30Z
      required: [id, grid_id, user_id, volunteer_name, status, created_date]
    VolunteersListResponse:
      type: object
      description: 志工清單回應外層封裝
      properties:
        data:
          type: array
          description: 志工報名資料陣列
          items:
            $ref: '#/components/schemas/VolunteerListItem'
        can_view_phone:
          type: boolean
          description: 是否允許前端顯示 `volunteer_phone`；由後端依角色授權判斷
          example: true
        total:
          type: integer
          description: 總筆數 (分頁時可用)
          example: 128
        status_counts:
          type: object
          description: 各狀態統計 (若 `include_counts=true` 或後端預設回傳)
          properties:
            pending: { type: integer, example: 12 }
            confirmed: { type: integer, example: 34 }
            arrived: { type: integer, example: 8 }
            completed: { type: integer, example: 55 }
            cancelled: { type: integer, example: 19 }
        page:
          type: integer
          description: 目前頁碼 (可選, 若採用 page 模式)
          example: 1
        limit:
          type: integer
          description: 單頁筆數 (對應查詢參數)
          example: 50
      required: [data, can_view_phone]
    Task:
      type: object
      required: [id, title, status, location]
      properties:
        id:
          type: string
          format: uuid
          description: Unique task identifier
        title:
          type: string
          maxLength: 140
          minLength: 1
          description: Task title
        description:
          type: string
          maxLength: 4000
          nullable: true
          description: Detailed task description
        status:
          type: string
          enum: [open, assigned, done, cancelled]
          description: Current task status
        skills:
          type: array
          items:
            type: string
            maxLength: 50
          maxItems: 20
          nullable: true
          description: Required skills for the task
        location:
          type: object
          required: [lat, lon]
          properties:
            lat: { type: number, minimum: -90, maximum: 90 }
            lon: { type: number, minimum: -180, maximum: 180 }
          description: Task location coordinates
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
      example:
        id: "123e4567-e89b-12d3-a456-426614174000"
        title: "清理街道淤泥"
        description: "中山路一段需要清理淤泥約50公尺"
        status: "open"
        skills: ["體力勞動", "鏟子使用"]
        location:
          lat: 23.9739
          lon: 121.6056
        createdAt: "2025-10-02T10:00:00Z"
        updatedAt: "2025-10-02T10:00:00Z"

    VolunteerSignup:
      type: object
      required: [name, phone]
      description: |
        Volunteer signup schema with idempotent submission support.
        Custom extension x-shovel-heroes-idempotency-window-seconds (600 seconds)
        defines the deduplication window for preventing duplicate signups.
      properties:
        name:
          type: string
          maxLength: 80
          minLength: 1
          description: Volunteer full name
        phone:
          type: string
          description: |
            Taiwan phone number validation (see x-phone-validation for pattern components).

            Accepted formats:
              • Mobile: 09XX-XXX-XXX (prefixes: 091x-099x, excludes 090x)
              • Landline: 0X-XXXX-XXXX (area codes: 02, 03, 04, 05, 06, 07, 08, 049)
              • International: +886-X-XXXX-XXXX or +886-9XX-XXX-XXX

            Examples: 0912-345-678, 02-2345-6789, 049-123-4567, +886-2-2345-6789

            Server performs additional validation.
          pattern: "^(\\+886-?(2|3|4|5|6|7|8|49)-?[0-9]{3,4}-?[0-9]{4}|\\+886-?9[1-9][0-9]-?[0-9]{3}-?[0-9]{3}|0(2|3|4|5|6|7|8|49)-?[0-9]{3,4}-?[0-9]{4}|09[1-9][0-9]-?[0-9]{3}-?[0-9]{3})$"
          x-phone-validation:
            components:
              international-landline:
                pattern: "\\+886-?(2|3|4|5|6|7|8|49)-?[0-9]{3,4}-?[0-9]{4}"
                description: "International format with Taiwan area codes"
                examples: ["+886-2-2345-6789", "+88622345678", "+886-49-123-4567"]
              international-mobile:
                pattern: "\\+886-?9[1-9][0-9]-?[0-9]{3}-?[0-9]{3}"
                description: "International mobile format (prefixes 910-999)"
                examples: ["+886-912-345-678", "+886912345678"]
              domestic-landline:
                pattern: "0(2|3|4|5|6|7|8|49)-?[0-9]{3,4}-?[0-9]{4}"
                description: "Domestic landline with area code"
                examples: ["02-2345-6789", "022345678", "049-123-4567"]
              domestic-mobile:
                pattern: "09[1-9][0-9]-?[0-9]{3}-?[0-9]{3}"
                description: "Domestic mobile (prefixes 091x-099x)"
                examples: ["0912-345-678", "0912345678"]
            notes:
              - "All dashes (-) are optional throughout"
              - "Area code 049 is for Nantou County"
              - "Mobile prefixes 090x are invalid and excluded"
              - "Area codes 00, 01, 09 are invalid for landlines"
        email:
          type: string
          format: email
          maxLength: 254
          nullable: true
          description: Contact email address
        skills:
          type: array
          items:
            type: string
            maxLength: 50
          maxItems: 20
          nullable: true
          description: Volunteer skills and expertise
        locationPref:
          type: string
          maxLength: 100
          nullable: true
          description: Preferred work location (e.g., city or district name)
      x-shovel-heroes-idempotency-window-seconds: 600  # aligns with "10 minutes cooldown" in product spec
      example:
        name: "張小明"
        phone: "0912-345-678"
        email: "example@email.com"
        skills: ["醫療", "重機具操作"]
        locationPref: "花蓮市"

    VolunteerSignupReceipt:
      type: object
      required: [id, receivedAt]
      properties:
        id:
          type: string
          format: uuid
          description: Server-issued unique volunteer identifier
        receivedAt:
          type: string
          format: date-time
          description: Timestamp when signup was received
      example:
        id: "987fcdeb-51a2-43d7-b456-426614174999"
        receivedAt: "2025-10-02T10:30:00Z"

    Checkin:
      type: object
      required: [position]
      properties:
        position:
          type: object
          required: [lat, lon]
          properties:
            lat: { type: number, minimum: -90, maximum: 90 }
            lon: { type: number, minimum: -180, maximum: 180 }
          description: Check-in GPS coordinates
        note:
          type: string
          maxLength: 500
          nullable: true
          description: Optional check-in note or status update
      example:
        position:
          lat: 23.9739
          lon: 121.6056
        note: "已抵達物資集散點"

    CheckinReceipt:
      type: object
      required: [id, at]
      properties:
        id:
          type: string
          format: uuid
          description: Unique check-in record identifier
        at:
          type: string
          format: date-time
          description: Server timestamp of check-in
      example:
        id: "456e7890-a12b-34c5-d678-901234567890"
        at: "2025-10-02T11:00:00Z"

    ResourcePoint:
      type: object
      required: [id, name, kind, location]
      properties:
        id:
          type: string
          format: uuid
          description: Unique resource point identifier
        name:
          type: string
          maxLength: 200
          minLength: 1
          description: Resource point name
        kind:
          type: string
          enum: [shelter, supply, medical, other]
          description: Type of resource point
        location:
          type: object
          required: [lat, lon]
          properties:
            lat: { type: number, minimum: -90, maximum: 90 }
            lon: { type: number, minimum: -180, maximum: 180 }
          description: Resource point GPS coordinates
        address:
          type: string
          maxLength: 300
          nullable: true
          description: Physical address
        hours:
          type: string
          maxLength: 100
          nullable: true
          description: Operating hours
      example:
        id: "abc12345-def6-7890-ghij-klmnopqrstuv"
        name: "花蓮市立體育館避難所"
        kind: "shelter"
        location:
          lat: 23.9739
          lon: 121.6056
        address: "花蓮縣花蓮市中山路123號"
        hours: "24小時開放"

    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          maxLength: 50
          description: Machine-readable error code
        message:
          type: string
          maxLength: 500
          description: Human-readable error message
        traceId:
          type: string
          format: uuid
          nullable: true
          description: Request trace ID for debugging
      example:
        code: "VALIDATION_ERROR"
        message: "電話號碼格式不正確"
        traceId: "trace-123e4567-e89b-12d3-a456-426614174000"

    Announcement:
      type: object
      required: [id, title, content, category]
      properties:
        id:
          type: string
          description: Unique announcement identifier
        title:
          type: string
          maxLength: 200
          description: Announcement title
        content:
          type: string
          maxLength: 4000
          description: Announcement content
        category:
          type: string
          enum: [safety, equipment, general]
          description: Announcement category
        is_pinned:
          type: boolean
          default: false
          description: Whether announcement is pinned
        external_links:
          type: array
          items:
            type: string
            format: uri
          nullable: true
          description: External reference links
        contact_phone:
          type: string
          nullable: true
          description: Contact phone number
        order:
          type: integer
          minimum: 1
          description: Display order
        created_date:
          type: string
          format: date-time
        updated_date:
          type: string
          format: date-time
      example:
        id: "68d8ca4c4e916245edf761df"
        title: "安全第一"
        content: "照顧好自己才能幫助他人\n避免單獨行動\n保持距離\n注意周遭環境"
        category: "safety"
        is_pinned: true
        external_links: []
        contact_phone: null
        order: 1
        created_date: "2025-09-28T05:40:28.625Z"
        updated_date: "2025-09-28T05:40:28.625Z"

    DisasterArea:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/ID'
        name:
          type: string
          description: 災區名稱
          example: 光復鄉重災區
        township:
          type: string
          description: 行政區 (鄉/鎮)
          example: 光復鄉
        county:
          type: string
          description: 縣市名稱
          example: 花蓮縣
        center_lat:
          type: number
          format: double
          description: 災區中心點緯度
          example: 23.8751
        center_lng:
          type: number
          format: double
          description: 災區中心點經度
          example: 121.578
        bounds:
          type: object
          description: 災區邊界 (近似方形) 用於地圖顯示
          properties:
            north: { type: number, example: 23.6705 }
            south: { type: number, example: 23.6505 }
            east: { type: number, example: 121.4325 }
            west: { type: number, example: 121.4125 }
          required:
            - north
            - south
            - east
            - west
        grid_size:
          type: integer
          description: 建議網格尺寸 (公尺)
          example: 200
        status:
          type: string
          description: 災區狀態 (Base44 目前觀察為 active)
          enum: [active]
          example: active
        description:
          type: string
          description: 災區描述與備註
          example: 包含馬太鞍部落、佛祖街、自強路、武昌街等重災區域
        created_by_id:
          $ref: '#/components/schemas/ID'
        created_by:
          type: string
          description: 建立者識別 (可能為 email)
          example: kuo.tanya@gmail.com
        is_sample:
          type: boolean
          description: 是否為示範資料
          example: false
        created_at:
          $ref: '#/components/schemas/Timestamp'
        updated_at:
          $ref: '#/components/schemas/Timestamp'
        created_date:
          $ref: '#/components/schemas/Timestamp'
        updated_date:
          $ref: '#/components/schemas/Timestamp'
      required: [id, name, center_lat, center_lng]

    Grid:
      type: object
      required: [id, code, grid_type, disaster_area_id, center_lat, center_lng]
      properties:
        id:
          type: string
          description: Unique grid identifier
        code:
          type: string
          maxLength: 50
          description: Grid code (e.g., A-1, B-2)
        grid_type:
          type: string
          enum: [mud_disposal, manpower, supply_storage, accommodation, food_area]
          default: manpower
          description: Grid type
        disaster_area_id:
          type: string
          description: Parent disaster area ID
        center_lat:
          type: number
          minimum: -90
          maximum: 90
          description: Grid center latitude
        center_lng:
          type: number
          minimum: -180
          maximum: 180
          description: Grid center longitude
        bounds:
          type: object
          nullable: true
          properties:
            north: { type: number, minimum: -90, maximum: 90 }
            south: { type: number, minimum: -90, maximum: 90 }
            east: { type: number, minimum: -180, maximum: 180 }
            west: { type: number, minimum: -180, maximum: 180 }
          description: Grid boundaries
        volunteer_needed:
          type: integer
          minimum: 0
          default: 0
          description: Number of volunteers needed
        volunteer_registered:
          type: integer
          minimum: 0
          default: 0
          description: Number of registered volunteers
        supplies_needed:
          type: array
          nullable: true
          items:
            type: object
            required: [name, quantity, unit]
            properties:
              name:
                type: string
                maxLength: 100
                description: Supply item name
              quantity:
                type: integer
                minimum: 0
                description: Quantity needed
              unit:
                type: string
                maxLength: 20
                description: Unit of measurement
              received:
                type: integer
                minimum: 0
                default: 0
                description: Quantity received
          description: List of needed supplies
        grid_manager_id:
          type: string
          nullable: true
          description: Grid manager user ID
        meeting_point:
          type: string
          maxLength: 200
          nullable: true
          description: Meeting point location
        risks_notes:
          type: string
          maxLength: 1000
          nullable: true
          description: Risk and safety notes
        contact_info:
          type: string
          maxLength: 200
          nullable: true
          description: Contact information
        status:
          type: string
          enum: [planning, open, in_progress, completed, closed]
          default: planning
          description: Grid status
        completion_photo:
          type: string
          format: uri
          nullable: true
          description: Completion photo URL
        created_date:
          type: string
          format: date-time
        updated_date:
          type: string
          format: date-time
      example:
        id: "68dd5b4cf6dff118dc08f70a"
        code: "A-18"
        grid_type: "manpower"
        disaster_area_id: "68d7d97f32d4040fdba931d7"
        center_lat: 23.66779522
        center_lng: 121.4656618
        bounds:
          north: 23.668795222641794
          south: 23.66679522264179
          east: 121.46666182374956
          west: 121.46466182374955
        volunteer_needed: 20
        volunteer_registered: 6
        supplies_needed: []
        grid_manager_id: "68d7d7b836364938a22cd52c"
        meeting_point: "花蓮市建國路30號"
        risks_notes: "注意高壓電線\n避免單獨作業\n配戴安全帽和手套\n小心濕滑路面"
        contact_info: "0938-348-901"
        status: "open"
        completion_photo: null
        created_date: "2025-10-01T16:48:12.388Z"
        updated_date: "2025-10-01T16:48:12.388Z"

    GridDiscussion:
      type: object
      required: [id, grid_id, author_name, message]
      properties:
        id:
          type: string
          description: Unique message identifier
        grid_id:
          type: string
          description: Grid ID this message belongs to
        author_name:
          type: string
          maxLength: 100
          description: Message author name
        author_role:
          type: string
          enum: [admin, grid_manager, volunteer, donor]
          nullable: true
          description: Author role
        message:
          type: string
          maxLength: 2000
          description: Message content
        message_type:
          type: string
          enum: [info, question, update, alert]
          default: info
          description: Message type
        photo_url:
          type: string
          format: uri
          nullable: true
          description: Attached photo URL
        is_pinned:
          type: boolean
          default: false
          description: Whether message is pinned
        created_date:
          type: string
          format: date-time
        updated_date:
          type: string
          format: date-time
      example:
        id: "68da11cc2a5558f52407d189"
        grid_id: "68da0b817e1bb04f4ff21d73"
        author_name: "張小明"
        author_role: "volunteer"
        message: "已完成清理工作，準備撤離"
        message_type: "info"
        photo_url: null
        is_pinned: false
        created_date: "2025-09-29T04:57:48.661Z"
        updated_date: "2025-09-29T04:57:48.661Z"

    GridDiscussionPost:
      type: object
      required: [message]
      properties:
        message:
          type: string
          maxLength: 2000
          description: Message content
        message_type:
          type: string
          enum: [info, question, update, alert]
          default: info
          description: Message type
        photo_url:
          type: string
          format: uri
          nullable: true
          description: Attached photo URL
        is_pinned:
          type: boolean
          default: false
          description: Whether to pin this message
      example:
        message: "物資已到達集合點，請志工前來領取"
        message_type: "update"
        photo_url: null
        is_pinned: false

    GridVolunteerRegistration:
      type: object
      required: [volunteer_name]
      properties:
        volunteer_name:
          type: string
          maxLength: 100
          description: Volunteer name
        volunteer_phone:
          type: string
          nullable: true
          description: Volunteer phone number
        volunteer_email:
          type: string
          format: email
          maxLength: 254
          nullable: true
          description: Volunteer email
        available_time:
          type: string
          maxLength: 200
          nullable: true
          description: Available time slots
        skills:
          type: array
          nullable: true
          items:
            type: string
            maxLength: 50
          maxItems: 20
          description: Volunteer skills
        equipment:
          type: array
          nullable: true
          items:
            type: string
            maxLength: 50
          maxItems: 20
          description: Equipment brought by volunteer
        notes:
          type: string
          maxLength: 500
          nullable: true
          description: Additional notes
      example:
        volunteer_name: "李大華"
        volunteer_phone: "0912-345-678"
        volunteer_email: "volunteer@example.com"
        available_time: "10/2 9:00-17:00"
        skills: ["重機具操作", "醫療救護"]
        equipment: ["鏟子", "安全帽"]
        notes: "有重機具操作經驗"

    GridVolunteerRegistrationReceipt:
      type: object
      required: [id, grid_id, status]
      properties:
        id:
          type: string
          description: Registration ID
        grid_id:
          type: string
          description: Grid ID
        status:
          type: string
          enum: [pending, confirmed, arrived, completed, cancelled]
          description: Registration status
        check_in_time:
          type: string
          format: date-time
          nullable: true
          description: Check-in timestamp
        created_date:
          type: string
          format: date-time
          description: Registration timestamp
      example:
        id: "68dd5a90e624c3bdf539ab43"
        grid_id: "68d8dbb94463cbe78e2057ab"
        status: "confirmed"
        check_in_time: null
        created_date: "2025-10-01T16:45:04.339Z"

    SupplyDonation:
      type: object
      required: [grid_id, donor_name, donor_phone, supply_name, quantity]
      properties:
        id:
          type: string
          description: Unique donation identifier
        grid_id:
          type: string
          description: Target grid ID
        donor_name:
          type: string
          maxLength: 100
          description: Donor name
        donor_phone:
          type: string
          description: Donor phone number
        donor_email:
          type: string
          format: email
          maxLength: 254
          nullable: true
          description: Donor email
        supply_name:
          type: string
          maxLength: 100
          description: Supply item name
        quantity:
          type: integer
          minimum: 1
          description: Donation quantity
        delivery_method:
          type: string
          enum: [direct, pickup_point, volunteer_pickup]
          nullable: true
          description: Delivery method
        delivery_address:
          type: string
          maxLength: 300
          nullable: true
          description: Delivery address
        delivery_time:
          type: string
          maxLength: 100
          nullable: true
          description: Expected delivery time
        status:
          type: string
          enum: [pledged, confirmed, in_transit, delivered, cancelled]
          default: pledged
          description: Donation status
        received_photo:
          type: string
          format: uri
          nullable: true
          description: Receipt photo URL
        notes:
          type: string
          maxLength: 500
          nullable: true
          description: Additional notes
        created_date:
          type: string
          format: date-time
        updated_date:
          type: string
          format: date-time
      example:
        id: "68dd5cea2448a49f79cc533c"
        grid_id: "existing_grid_id_2"
        donor_name: "慈濟基金會"
        donor_phone: "089-1234567"
        donor_email: "logistics@example.com"
        supply_name: "礦泉水"
        quantity: 50
        delivery_method: "pickup_point"
        delivery_address: null
        delivery_time: "今日10:00"
        status: "confirmed"
        received_photo: null
        notes: "提供礦泉水50箱"
        created_date: "2025-10-01T16:55:06.312Z"
        updated_date: "2025-10-01T16:55:06.312Z"

    SupplyDonationReceipt:
      type: object
      required: [id, status]
      properties:
        id:
          type: string
          description: Donation ID
        status:
          type: string
          enum: [pledged, confirmed, in_transit, delivered, cancelled]
          description: Current donation status
        created_date:
          type: string
          format: date-time
          description: Registration timestamp
      example:
        id: "68dd5cea2448a49f79cc533c"
        status: "pledged"
        created_date: "2025-10-01T16:55:06.312Z"

x-guidelines:
  rateLimit:
    defaultPolicy: "100 requests/30s; 1000 requests/day"
    headers: ["RateLimit", "RateLimit-Policy", "Retry-After(429)"]
  securityHeaders:
    - "HSTS"
    - "CORS strict"
    - "No detailed stack traces to clients"
  customExtensions:
    x-shovel-heroes-idempotency-window-seconds:
      description: "Specifies the time window (in seconds) for idempotency key deduplication. Used on POST endpoints to prevent duplicate submissions."
      usage: "Server maintains idempotency keys for this duration. Duplicate requests within the window return 409 Conflict with Retry-After header."
